CREATE OR REPLACE FUNCTION broker_commission_pct (BID IN NUMBER) RETURN NUMBER IS 
COM_PCT NUMBER (5,2);
BEGIN 
SELECT LEAST(0.01 + ROUND(NVL(SUM(LATEST_QUANTITY),0)/100000,0)*0.01,4) INTO COM_PCT
FROM CUSTOMER LEFT OUTER JOIN "ORDER" ON "ORDER".USER_ID = CUSTOMER.USER_ID
WHERE STATUS = 'SUCCESS' AND BROKER_ID = BID;
RETURN COM_PCT;
EXCEPTION
WHEN OTHERS THEN 
	RETURN 0;
END;
/