CREATE OR REPLACE PROCEDURE sell_order_success(
    OID IN NUMBER
    ,BUYER_ID IN VARCHAR2
)IS 
ORDER_SYM VARCHAR2(30);
LATEST_QUANTITY NUMBER(10,2);
LATEST_PRICE NUMBER(10,2);
SELLER_ID NUMBER(10,2);
TYP VARCHAR2(30);
SYM VARCHAR2(40);
COUNT_SYM NUMBER;
USID NUMBER;
FLAG NUMBER;
FUND NUMBER(10,2);
NUM_LOT NUMBER(10,2);
BEGIN
    SELECT SYMBOL INTO ORDER_SYM FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT USER_ID INTO SELLER_ID FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT LATEST_PRICE INTO LATEST_PRICE FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT LATEST_QUANTITY INTO LATEST_QUANTITY FROM "ORDER" WHERE ORDER_ID = OID;
		
    IF BUYER_ID = SELLER_ID THEN 
        RAISE_APPLICATION_ERROR(-20008,'Buyer and seller must be different');
    END IF;


    SELECT "TYPE" INTO TYP FROM "USER" WHERE USER_ID = BUYER_ID;
    IF TYP = 'Customer' THEN 
        SELECT COUNT(*) INTO COUNT_SYM 
        FROM OWNS WHERE SYMBOL = ORDER_SYM AND USER_ID = BUYER_ID;
                    
        IF COUNT_SYM = 0 THEN 
            INSERT INTO OWNS VALUES(BUYER_ID,ORDER_SYM,LATEST_QUANTITY);
        ELSE 
            UPDATE OWNS
            SET QUANTITY = QUANTITY + LATEST_QUANTITY
            WHERE USER_ID = BUYER_ID AND SYMBOL = ORDER_SYM;
        END IF;

        SELECT COUNT(*) INTO FLAG 
        FROM PORTFOLIO WHERE SECTOR = SECTOR_OF_STOCK(ORDER_SYM) AND USER_ID = BUYER_ID;
        
        IF FLAG = 0 THEN
            INSERT INTO PORTFOLIO VALUES (BUYER_ID,SECTOR_OF_STOCK(ORDER_SYM),LATEST_PRICE*LATEST_QUANTITY,0);
        ELSE 
            UPDATE PORTFOLIO
            SET BUY_AMOUNT = BUY_AMOUNT + LATEST_PRICE*LATEST_QUANTITY
            WHERE USER_ID = BUYER_ID AND SECTOR = SECTOR_OF_STOCK(ORDER_SYM);
        END IF;
    ELSIF TYP = 'Admin' THEN 
        FUND := 0;
        SELECT FUNDS INTO FUND FROM ADMIN WHERE ADMIN_ID = BUYER_ID;

        IF FUND < LATEST_PRICE*LATEST_QUANTITY THEN 
            RAISE_APPLICATION_ERROR(-20007,'Insufficient funds');
        END IF;

        UPDATE ADMIN
        SET FUNDS = FUNDS - LATEST_PRICE*LATEST_QUANTITY
        WHERE ADMIN_ID = BUYER_ID;


		SELECT COUNT(*) INTO COUNT_SYM 
        FROM "BACKUP STOCK"
        WHERE SYMBOL = ORDER_SYM;
				
		SELECT LOT INTO NUM_LOT FROM STOCK WHERE SYMBOL = ORDER_SYM ;

        IF COUNT_SYM = 0 THEN
            INSERT INTO "BACKUP STOCK" VALUES (ORDER_SYM,LATEST_QUANTITY/NUM_LOT,'F');
        ELSE 
            UPDATE "BACKUP STOCK" 
            SET AVAILABLE_LOTS = AVAILABLE_LOTS + (LATEST_QUANTITY/NUM_LOT)
            WHERE SYMBOL = ORDER_SYM;
        END IF;
    END IF;

    UPDATE "ORDER"
    SET STATUS = 'SUCCESS'
    WHERE ORDER_ID = OID;
		
		INSERT INTO USER_LOG(USER_ID,EVENT_TYPE,DESCRIPTION) VALUES (BUYER_ID,'PURCHASE','You purchased '||(LATEST_QUANTITY/NUM_LOT)||' number of lots of '||ORDER_SYM||' at price '||LATEST_PRICE);
	
	INSERT INTO ADMIN_LOG(EVENT_TYPE,DESCRIPTION) VALUES ('PURCHASE',OID||' purchased '||(LATEST_QUANTITY/NUM_LOT)||' number of lots of '||ORDER_SYM||' at price '||LATEST_PRICE||' from '||SELLER_ID);
		
		
EXCEPTION
WHEN OTHERS THEN 
	ROLLBACK;
END;
/