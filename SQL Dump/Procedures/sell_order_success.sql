CREATE OR REPLACE PROCEDURE sell_order_success(
    OID IN NUMBER
    ,BUYER_ID IN VARCHAR2
)IS 
ORDER_SYM VARCHAR2(30);
LATEST_QUANTITY NUMBER(10,2);
LATEST_PRICE NUMBER(10,2);
SELLER_ID NUMBER(10,2);
TYP VARCHAR2(30);
SYM VARCHAR2(40);
USID NUMBER;
PORTFOLIO_SECTOR VARCHAR2(40);
FUND NUMBER(10,2);
BEGIN
    SELECT SYMBOL INTO ORDER_SYM FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT USER_ID INTO SELLER_ID FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT LATEST_PRICE INTO LATEST_PRICE FROM "ORDER" WHERE ORDER_ID = OID;
    SELECT LATEST_QUANTITY INTO LATEST_QUANTITY FROM "ORDER" WHERE ORDER_ID = OID;


    SELECT "TYPE" INTO TYP FROM "USER" WHERE USER_ID = BUYER_ID;
    IF TYP = 'Customer' THEN 
        SELECT SYMBOL INTO SYM FROM OWNS WHERE SYMBOL = ORDER_SYM AND USER_ID = BUYER_ID;
        SELECT USER_ID INTO USID FROM OWNS WHERE SYMBOL = ORDER_SYM AND USER_ID = BUYER_ID;
                    
        IF SYM IS NULL OR USID IS NULL THEN 
            INSERT INTO OWNS VALUES(BUYER_ID,ORDER_SYM,LATEST_QUANTITY);
        ELSE 
            UPDATE OWNS
            SET QUANTITY = QUANTITY + :NEW.LATEST_QUANTITY
            WHERE USER_ID = BUYER_ID AND SYMBOL = ORDER_SYM;
        END IF;

        SELECT SECTOR INTO PORTFOLIO_SECTOR FROM PORTFOLIO WHERE SECTOR = SECTOR_OF_STOCK(ORDER_SYM) AND USER_ID = BUYER_ID;
        SELECT USER_ID INTO USID FROM PORTFOLIO WHERE SECTOR = SECTOR_OF_STOCK(ORDER_SYM) AND USER_ID = BUYER_ID;
        
        IF PORTFOLIO_SECTOR IS NULL OR USID IS NULL THEN
            INSERT INTO PORTFOLIO VALUES (BUYER_ID,SECTOR_OF_STOCK(ORDER_SYM),LATEST_PRICE*LATEST_QUANTITY,0);
        ELSE 
            UPDATE PORTFOLIO
            SET BUY_AMOUNT = BUY_AMOUNT + LATEST_PRICE*LATEST_QUANTITY
            WHERE USER_ID = USID AND SECTOR = PORTFOLIO_SECTOR;
        END IF;
    ELSE IF TYP = 'Admin' THEN 
        SELECT FUNDS INTO FUND FROM ADMIN WHERE ADMIN_ID = BUYER_ID;

        IF FUND IS NULL OR FUND < LATEST_PRICE*LATEST_QUANTITY THEN 
            RAISE_APPLICATION_ERROR(-20007,'Insufficient funds');
        END IF;

        UPDATE ADMIN
        SET FUNDS = FUNDS - LATEST_PRICE*LATEST_QUANTITY
        WHERE ADMIN_ID = BUYER_ID;

        SELECT SYMBOL INTO SYM 
        FROM "BACKUP STOCK"
        WHERE SYMBOL = ORDER_SYM;

        IF SYM IS NULL THEN
            INSERT INTO "BACKUP STOCK" VALUES (:NEW.SYMBOL,:NEW.LATEST_QUANTITY/(SELECT LOT FROM STOCK WHERE SYMBOL = :NEW.SYMBOL));
        ELSE 
            UPDATE "BACKUP STOCK" 
            SET AVAILABLE_LOTS = AVAILABLE_LOTS + :NEW.LATEST_QUANTITY/(SELECT LOT FROM STOCK WHERE SYMBOL = :NEW.SYMBOL)
            WHERE SYMBOL = :NEW.SYMBOL;
        END IF;
    END IF;

    UPDATE "ORDER"
    SET STATUS = 'SUCCESS'
    WHERE ORDER_ID = OID;
END;